<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ASL Car Simulator - Hyper Drive Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* ... (CSS 样式部分与之前相同) ... */
    </style>
</head>
<body>

    <div id="loading-screen">
        <h2 style="margin:0; font-size:32px; color:white; font-family:'Orbitron';">SYSTEM INITIALIZING</h2>
        <p style="font-family:'Orbitron'; letter-spacing:2px;">OPEN WORLD HYPER DRIVE</p>
        <div id="loading-progress-bar"><div id="loading-progress-fill"></div></div>
        <p id="loading-status" style="margin-top:10px; font-size:14px; font-family:'Rajdhani';">(0%) Loading Assets...</p> </div>

    <div class="copyright-tag">ZHANYI ZHOU DESIGN © 2025</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/DRACOLoader.js"></script>

    <script>
    // =============================================================================
    // ** CORE VARIABLES **
    // =============================================================================
    let scene, renderer;
    let cameraChase, cameraCockpit, activeCamera;
    let world, vehicle, chassisBody;
    let wheelMeshes = [];
    let lastTime = undefined;

    let isGameRunning = false; 
    let splashCameraAngle = 0; 
    let isDragging = false;
    let previousMouseX = 0;

    const daySkyColor = new THREE.Color(0x87CEEB);
    const dayHemiSky = new THREE.Color(0xffffff);
    const dayHemiGround = new THREE.Color(0x3b4c5a);

    const maxEngineForce = 9000; 
    const brakeForce = 40;
    const maxSteerVal = 0.7;
    const VISUAL_Y_OFFSET = -0.9; 

    // ** Initial Vehicle Position **
    const initialCarPosition = new CANNON.Vec3(90, 0.7, 0);

    // ** AI Vehicle Variables **
    let aiVehicle;
    let aiChassisBody;
    let aiCarMesh = null;
    let aiWheelMeshes = [];

    // AI Patrol Vars
    const PATROL_POINTS = [
        // FIX: 将 AI 车的起始点改为 x=-90, z=30，并将 Y 轴提高到 1.0 
        new THREE.Vector3(-90, 1.0, 30), 
        // 保持其他巡逻点相对高度一致
        new THREE.Vector3(-500, 1.0, 500),
        new THREE.Vector3(-500, 1.0, -500),
        new THREE.Vector3(100, 1.0, -500)
    ]; // Simple square patrol route
    let currentPatrolIndex = 0;
    const PATROL_THRESHOLD = 50; // Distance to next waypoint before switching

    // ... (其他变量与函数定义保持不变) ...

    function initAIVehicle() {
        // Ensure AI car model is loaded and tire prototype is ready
        if (!aiCarMesh || !tireMeshPrototype) {
            return; 
        }

        const chassisShape = new CANNON.Box(new CANNON.Vec3(1, 0.5, 2));
        aiChassisBody = new CANNON.Body({
            mass: 2500, 
            shape: chassisShape,
            // Start at the first patrol point (已在 PATROL_POINTS 中修改)
            position: new CANNON.Vec3(PATROL_POINTS[0].x, PATROL_POINTS[0].y, PATROL_POINTS[0].z) 
        });
        aiChassisBody.angularDamping = 0.9;
        aiChassisBody.linearDamping = 0.05;
        world.addBody(aiChassisBody);

        aiVehicle = new CANNON.RaycastVehicle({
            chassisBody: aiChassisBody,
            indexRightAxis: 0, indexUpAxis: 1, indexForwardAxis: 2
        });

        const axleWidth = 1.0;
        const wheelBase = 1.5;
        function makeAIWheelOptions(x,y,z) {
            return {
                radius: 0.5,
                directionLocal: new CANNON.Vec3(0, -1, 0),
                suspensionStiffness: 150, suspensionRestLength: 0.3,
                frictionSlip: 4.0, dampingRelaxation: 8.0, dampingCompression: 10.0,
                maxSuspensionForce: 100000, rollInfluence: 0.05, maxSuspensionTravel: 0.3,
                customSlidingRotationalSpeed: -30, useCustomSlidingRotationalSpeed: true,
                axleLocal: new CANNON.Vec3(1, 0, 0),
                chassisConnectionPointLocal: new CANNON.Vec3(x, -0.3, z)
            };
        }

        aiVehicle.addWheel(makeAIWheelOptions(-axleWidth, 0, wheelBase));
        aiVehicle.addWheel(makeAIWheelOptions( axleWidth, 0, wheelBase));
        aiVehicle.addWheel(makeAIWheelOptions(-axleWidth, 0, -wheelBase));
        aiVehicle.addWheel(makeAIWheelOptions( axleWidth, 0, -wheelBase));

        aiVehicle.addToWorld(world);

        aiWheelMeshes = [];
        for (let i = 0; i < aiVehicle.wheelInfos.length; i++) {
            const wheelMesh = tireMeshPrototype.clone();
            if(i===0 || i===2) wheelMesh.rotation.y = Math.PI;
            // 将 AI 车轮设置为紫色/洋红色以匹配车身
            wheelMesh.traverse((node) => { 
                if (node.isMesh) {
                    const mat = node.material.clone();
                    if (mat.color) mat.color.setHex(0xFF00FF); 
                    node.material = mat;
                } 
            });
            aiWheelMeshes.push(wheelMesh);
            scene.add(wheelMesh);
        }
    }
    // ... (animate 主循环和 updateAIControls 保持不变) ...

    </script>
</body>
</html>
