<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <title>OPEN WORLD HYPER DRIVE - REMASTERED</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* =========================================================================
         * UI BASE & TYPOGRAPHY
         * ========================================================================= */
        body { 
            margin: 0; overflow: hidden; background: #000; 
            font-family: 'Rajdhani', sans-serif; color: #E0FFFF; user-select: none; 
        }
        
        /* =========================================================================
         * HUD
         * ========================================================================= */
        #hud-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between;
            padding: 20px; box-sizing: border-box; z-index: 10;
        }

        .hud-top-left { display: flex; gap: 15px; flex-wrap: wrap; transform: scale(0.9); transform-origin: top left; }
        .hud-top-right { position: absolute; top: 20px; right: 20px; text-align: right;}
        
        .instrument {
            background: rgba(0, 15, 30, 0.8);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-left: 4px solid #00FFFF;
            backdrop-filter: blur(5px);
            padding: 10px 18px; min-width: 100px;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.1);
            transform: skewX(-10deg);
        }
        
        .label {
            font-family: 'Orbitron', sans-serif; font-size: 10px; color: #00FFFF; 
            font-weight: 700; letter-spacing: 1px; display:block; text-transform: uppercase;
            transform: skewX(10deg);
        }
        .value {
            font-family: 'Orbitron', sans-serif; font-size: 32px; font-weight: 900; 
            color: #FFF; text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            transform: skewX(10deg); display: inline-block;
        }
        .unit { font-size: 12px; color: #888; margin-left: 5px; transform: skewX(10deg); display: inline-block;}

        .spd-color { border-left-color: #00FFFF !important; }
        .rpm-color { border-left-color: #FF00FF !important; }
        .gear-color { border-left-color: #FFD700 !important; }

        #hud-coin {
            background: rgba(40, 30, 0, 0.85);
            border-left: 4px solid #FFD700;
            min-width: 160px; display: inline-block;
        }
        #hud-coin .label { color: #FFD700; }
        #coin-count { color: #FFD700; }

        /* Delivery HUD */
        #delivery-hud {
            position: absolute; top: 160px; left: 20px;
            background: rgba(0, 20, 0, 0.8);
            border-left: 4px solid #00FF00;
            padding: 15px; width: 280px;
            display: none; clip-path: polygon(0 0, 100% 0, 95% 100%, 0 100%);
        }
        .mission-title { color: #00FF00; font-weight: 900; font-family: 'Orbitron'; font-size: 14px; margin-bottom: 5px; border-bottom: 1px solid #004400;}
        .mission-detail { font-size: 18px; color: #fff; }

        /* Controls Hint */
        #control-hints {
            position: absolute; bottom: 20px; left: 20px;
            font-size: 12px; color: rgba(255,255,255,0.5);
            background: rgba(0,0,0,0.6); padding: 10px;
            border-radius: 5px; border: 1px solid #333;
        }

        /* =========================================================================
         * MENUS & SPLASH
         * ========================================================================= */
        #splash {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000000 100%);
            z-index: 999; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            transition: opacity 0.5s;
        }

        .splash-header h1 {
            font-family: 'Orbitron', sans-serif; font-size: 72px; margin: 0;
            background: linear-gradient(to right, #00FFFF, #FF00FF);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(0,255,255,0.4);
            text-align: center; line-height: 0.9;
        }
        .splash-subtitle { color: #888; letter-spacing: 5px; margin-top: 10px; font-weight: 600; text-align: center;}

        /* Menu Buttons */
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 50px; }
        
        .big-btn {
            font-family: 'Orbitron'; font-size: 24px; font-weight: 900;
            padding: 20px 40px; border: none; cursor: pointer;
            background: #00FFFF; color: #000;
            clip-path: polygon(10% 0, 100% 0, 90% 100%, 0 100%);
            transition: 0.3s; text-transform: uppercase;
        }
        .big-btn:hover { transform: scale(1.05); background: #fff; box-shadow: 0 0 30px #00FFFF; }
        .big-btn.secondary { background: transparent; border: 2px solid #FF00FF; color: #FF00FF; }
        .big-btn.secondary:hover { background: #FF00FF; color: #000; box-shadow: 0 0 30px #FF00FF; }

        .small-menu { position: absolute; bottom: 30px; display: flex; gap: 15px; }
        .icon-btn {
            background: rgba(255,255,255,0.1); border: 1px solid #555; color: #aaa;
            padding: 10px 20px; cursor: pointer; font-family: 'Rajdhani'; font-weight: bold;
            transition: 0.3s;
        }
        .icon-btn:hover { background: #333; color: #fff; border-color: #fff; }

        /* =========================================================================
         * SHOP UI (NEW)
         * ========================================================================= */
        .menu-page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92); z-index: 1000;
            display: none; flex-direction: column; align-items: center; justify-content: flex-start;
            padding-top: 80px; opacity: 0; transition: opacity 0.3s;
        }
        .menu-page.active { opacity: 1; }
        
        .shop-container { display: flex; gap: 30px; margin-top: 40px; flex-wrap: wrap; justify-content: center;}
        
        .shop-item {
            background: rgba(20,20,30,0.8); border: 1px solid #333;
            width: 250px; padding: 20px; text-align: center;
            border-top: 4px solid #555; transition: 0.3s; position: relative;
        }
        .shop-item:hover { transform: translateY(-5px); border-top-color: #00FFFF; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .shop-item.owned { border-top-color: #00FF00; opacity: 0.6; }
        
        .item-title { font-family: 'Orbitron'; color: #fff; font-size: 18px; margin-bottom: 10px; }
        .item-desc { color: #aaa; font-size: 14px; height: 40px; margin-bottom: 20px; }
        .item-price { color: #FFD700; font-weight: bold; font-size: 20px; margin-bottom: 15px; }
        
        .buy-btn {
            background: #333; color: #fff; border: 1px solid #555; padding: 10px 20px;
            cursor: pointer; font-family: 'Orbitron'; transition: 0.2s; width: 100%;
        }
        .buy-btn:hover:not(:disabled) { background: #FFD700; color: #000; border-color: #FFD700; }
        .buy-btn:disabled { cursor: not-allowed; opacity: 0.5; }

        #close-menu { 
            position: absolute; top: 30px; right: 30px; background: none; border: none; 
            color: #fff; font-size: 30px; cursor: pointer; 
        }

        /* Loading */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 2000; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }
        #p-bar { width: 300px; height: 4px; background: #333; margin-top: 20px; border-radius: 2px;}
        #p-fill { width: 0%; height: 100%; background: #00FFFF; transition: width 0.2s; box-shadow: 0 0 10px #00FFFF;}

    </style>
</head>
<body>

    <div id="loading-screen">
        <h2 style="font-family:'Orbitron'; color:white; letter-spacing: 3px;">INITIALIZING SYSTEM</h2>
        <div id="p-bar"><div id="p-fill"></div></div>
        <p id="load-text" style="color:#666; font-size: 12px; margin-top: 10px;">Assets loading...</p>
    </div>

    <div id="splash">
        <div class="splash-header">
            <h1>OPEN WORLD<br>HYPER DRIVE</h1>
            <p class="splash-subtitle">V 2.0 // PROGRESS SAVED</p>
        </div>
        
        <div style="position:absolute; top:30px; right:30px; text-align:right;">
            <div style="color:#FFD700; font-family:'Orbitron'; font-size:24px;">
                <span id="menu-coins">0</span> ðŸ“€
            </div>
            <div style="color:#888; font-size:12px;">AVAILABLE FUNDS</div>
        </div>

        <div class="menu-grid">
            <button class="big-btn" onclick="startDeliveryMode()">START MISSION</button>
            <button class="big-btn secondary" onclick="openShop()">UPGRADE SHOP</button>
        </div>

        <div class="small-menu">
            <button class="icon-btn" onclick="enterGame()">FREE ROAM</button>
            <button class="icon-btn" onclick="alert('Controls:\nWASD - Drive\nSHIFT - Nitro\nSPACE - Drift/Brake\nV - Camera\nR - Respawn')">CONTROLS</button>
        </div>
        
        <div style="position: absolute; bottom: 10px; font-size: 10px; color: #444;">ZHANYI ZHOU DESIGN Â© 2025</div>
    </div>

    <div id="shop-page" class="menu-page">
        <button id="close-menu" onclick="closeShop()">Ã—</button>
        <h2 style="font-family:'Orbitron'; font-size: 40px; color:#FF00FF; text-shadow:0 0 20px #FF00FF;">PERFORMANCE SHOP</h2>
        <div style="color:#FFD700; font-family:'Orbitron'; margin-bottom: 20px;">BALANCE: <span id="shop-balance">0</span></div>
        
        <div class="shop-container">
            <div class="shop-item" id="item-engine">
                <div class="item-title">TURBO CHARGER V2</div>
                <div class="item-desc">Increases top speed and acceleration by 30%.</div>
                <div class="item-price">500 Gold</div>
                <button class="buy-btn" onclick="buyItem('engine')">PURCHASE</button>
            </div>
            
            <div class="shop-item" id="item-multiplier">
                <div class="item-title">COIN MAGNET CHIP</div>
                <div class="item-desc">Double (2x) all gold earned from missions.</div>
                <div class="item-price">1000 Gold</div>
                <button class="buy-btn" onclick="buyItem('multiplier')">PURCHASE</button>
            </div>
            
            <div class="shop-item" id="item-skin">
                <div class="item-title">NEON BLUE PAINT</div>
                <div class="item-desc">Apply a custom Midnight Blue neon coating.</div>
                <div class="item-price">250 Gold</div>
                <button class="buy-btn" onclick="buyItem('skin')">PURCHASE</button>
            </div>
        </div>
    </div>

    <div id="hud-layer" style="display:none;">
        <div class="hud-top-left">
            <div class="instrument spd-color"><span class="label">KM/H</span><span class="value" id="hud-spd">0</span></div>
            <div class="instrument rpm-color"><span class="label">RPM</span><span class="value" id="hud-rpm">0</span></div>
            <div class="instrument gear-color"><span class="label">GEAR</span><span class="value" id="hud-gear">N</span></div>
        </div>

        <div class="hud-top-right">
            <div class="instrument" id="hud-coin">
                <span class="label">CREDITS</span><span class="value" id="coin-count">0</span>
            </div>
        </div>

        <div id="delivery-hud">
            <div class="mission-title" id="mission-status">NO MISSION</div>
            <div class="mission-detail"><span id="dist-val">0</span>m | <span id="time-val" style="color:#FFD700;">00:00</span></div>
        </div>

        <div id="control-hints">
            [WASD] DRIVE | [SHIFT] NITRO | [SPACE] BRAKE | [V] CAM | [R] RESET
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/DRACOLoader.js"></script>

    <script>
    // =============================================================================
    // ** GAME STATE & SAVING (CRITICAL FOR RETENTION) **
    // =============================================================================
    const GameState = {
        coins: 0,
        upgrades: {
            engine: false,     // Level 2 Engine
            multiplier: false, // 2x Coins
            skinBlue: false    // Blue Skin
        },
        activeSkin: 'default'
    };

    function loadGame() {
        const saved = localStorage.getItem('hyperDriveSave');
        if (saved) {
            const parsed = JSON.parse(saved);
            GameState.coins = parsed.coins || 0;
            GameState.upgrades = parsed.upgrades || GameState.upgrades;
            GameState.activeSkin = parsed.activeSkin || 'default';
        }
        updateUI();
    }

    function saveGame() {
        localStorage.setItem('hyperDriveSave', JSON.stringify(GameState));
        updateUI();
    }

    function updateUI() {
        document.getElementById('menu-coins').innerText = GameState.coins;
        document.getElementById('shop-balance').innerText = GameState.coins;
        document.getElementById('coin-count').innerText = GameState.coins;
        
        // Update Shop Buttons
        checkShopState('engine', GameState.upgrades.engine);
        checkShopState('multiplier', GameState.upgrades.multiplier);
        checkShopState('skin', GameState.upgrades.skinBlue);
    }

    function checkShopState(id, isOwned) {
        const btn = document.querySelector(`#item-${id} .buy-btn`);
        const item = document.getElementById(`item-${id}`);
        if (isOwned) {
            btn.innerText = "OWNED";
            btn.disabled = true;
            item.classList.add('owned');
        }
    }

    // =============================================================================
    // ** SHOP LOGIC **
    // =============================================================================
    const PRICES = { engine: 500, multiplier: 1000, skin: 250 };

    window.openShop = function() {
        document.getElementById('shop-page').style.display = 'flex';
        setTimeout(() => document.getElementById('shop-page').classList.add('active'), 10);
    };

    window.closeShop = function() {
        document.getElementById('shop-page').classList.remove('active');
        setTimeout(() => document.getElementById('shop-page').style.display = 'none', 300);
    };

    window.buyItem = function(type) {
        if (GameState.coins >= PRICES[type]) {
            GameState.coins -= PRICES[type];
            if (type === 'engine') GameState.upgrades.engine = true;
            if (type === 'multiplier') GameState.upgrades.multiplier = true;
            if (type === 'skin') {
                GameState.upgrades.skinBlue = true;
                GameState.activeSkin = 'blue';
                applyCarSkin();
            }
            saveGame();
            alert("UPGRADE SUCCESSFUL!");
        } else {
            alert("INSUFFICIENT FUNDS! Go Play Missions!");
        }
    };

    // =============================================================================
    // ** CORE VARIABLES **
    // =============================================================================
    let scene, renderer, camera, world, vehicle, chassisBody;
    let isGameRunning = false;
    let cameraMode = 0; // 0: Chase, 1: Cockpit
    
    // Physics Config (Dynamic based on upgrades)
    let maxEngineForce = 1500; 
    let maxSteerVal = 0.5;
    let brakeForce = 25;
    
    // Assets
    let carMesh, arrowMesh, cityMesh;
    let coinMeshes = [], coinBodies = [];
    
    // Inputs
    const keys = { w:false, a:false, s:false, d:false, shift:false, space:false };

    // Delivery Config
    const DELIVERY_LOCS = [
        {x: 50, z: 50, n:"Downtown"}, {x: -200, z: 100, n:"Docks"},
        {x: 150, z: -200, n:"Suburbs"}, {x: -150, z: -150, n:"Factory"},
        {x: 300, z: 0, n:"Highway"}, {x: 0, z: 300, n:"Hills"}
    ];
    let mission = { active: false, target: null, type: 'none', timer: 0 }; // type: 'pickup' | 'dropoff'

    // =============================================================================
    // ** THREE JS & CANNON INIT **
    // =============================================================================
    function init() {
        loadGame();

        // Scene
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x111111);
        scene.fog = new THREE.FogExp2(0x111111, 0.002);

        // Lights
        const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6);
        scene.add(hemiLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(100, 200, 100);
        dirLight.castShadow = true;
        dirLight.shadow.mapSize.width = 2048;
        dirLight.shadow.mapSize.height = 2048;
        dirLight.shadow.camera.top = 200; dirLight.shadow.camera.bottom = -200;
        dirLight.shadow.camera.left = -200; dirLight.shadow.camera.right = 200;
        scene.add(dirLight);

        // Renderer
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5)); // Optimization
        document.body.appendChild(renderer.domElement);

        // Camera
        camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 1000);

        // Physics World
        world = new CANNON.World();
        world.gravity.set(0, -9.82, 0);
        world.broadphase = new CANNON.SAPBroadphase(world);
        world.defaultContactMaterial.friction = 0.1;

        // Ground
        const groundMat = new CANNON.Material();
        const groundBody = new CANNON.Body({ mass: 0, material: groundMat });
        groundBody.addShape(new CANNON.Plane());
        groundBody.quaternion.setFromEuler(-Math.PI/2, 0, 0);
        world.addBody(groundBody);

        const gridHelper = new THREE.GridHelper(2000, 100, 0x222222, 0x222222);
        scene.add(gridHelper);
        
        const groundMesh = new THREE.Mesh(
            new THREE.PlaneGeometry(2000, 2000),
            new THREE.MeshStandardMaterial({ color: 0x050505, roughness: 0.9 })
        );
        groundMesh.rotation.x = -Math.PI/2;
        groundMesh.receiveShadow = true;
        scene.add(groundMesh);

        initCar();
        loadAssets();
        animate();
    }

    function initCar() {
        // Upgrade Check
        if (GameState.upgrades.engine) maxEngineForce = 3000; // Boost speed if upgraded

        const chassisShape = new CANNON.Box(new CANNON.Vec3(1, 0.5, 2));
        chassisBody = new CANNON.Body({ mass: 150 });
        chassisBody.addShape(chassisShape, new CANNON.Vec3(0, 0.5, 0)); // Center of mass fix
        chassisBody.position.set(0, 2, 0);
        chassisBody.angularDamping = 0.5;
        
        vehicle = new CANNON.RaycastVehicle({
            chassisBody: chassisBody,
            indexRightAxis: 0, indexUpAxis: 1, indexForwardAxis: 2
        });
        
        const wheelOpts = {
            radius: 0.4, directionLocal: new CANNON.Vec3(0, -1, 0),
            suspensionStiffness: 30, suspensionRestLength: 0.3,
            frictionSlip: 2.5, dampingRelaxation: 2.3, dampingCompression: 4.4,
            maxSuspensionForce: 100000, rollInfluence: 0.01,
            axleLocal: new CANNON.Vec3(1, 0, 0),
            chassisConnectionPointLocal: new CANNON.Vec3(1, 1, 0),
            maxSuspensionTravel: 0.3, customSlidingRotationalSpeed: -30,
            useCustomSlidingRotationalSpeed: true
        };

        vehicle.addWheel({...wheelOpts, chassisConnectionPointLocal: new CANNON.Vec3(-1, 0, 1.2)});
        vehicle.addWheel({...wheelOpts, chassisConnectionPointLocal: new CANNON.Vec3(1, 0, 1.2)});
        vehicle.addWheel({...wheelOpts, chassisConnectionPointLocal: new CANNON.Vec3(-1, 0, -1.2)});
        vehicle.addWheel({...wheelOpts, chassisConnectionPointLocal: new CANNON.Vec3(1, 0, -1.2)});

        vehicle.addToWorld(world);
        
        // Wheel Bodies (Visuals)
        const wheelGeo = new THREE.CylinderGeometry(0.4, 0.4, 0.3, 24);
        wheelGeo.rotateZ(Math.PI/2);
        const wheelMat = new THREE.MeshStandardMaterial({ color: 0x333333 });
        
        vehicle.wheelInfos.forEach(w => {
            const mesh = new THREE.Mesh(wheelGeo, wheelMat);
            scene.add(mesh);
            w.mesh = mesh; // Link for update
        });
    }

    // =============================================================================
    // ** ASSET LOADING (WITH FALLBACKS) **
    // =============================================================================
    function loadAssets() {
        const loader = new THREE.GLTFLoader();
        const draco = new THREE.DRACOLoader();
        draco.setDecoderPath('https://www.gstatic.com/draco/v1/decoders/');
        loader.setDRACOLoader(draco);

        let itemsLoaded = 0;
        const totalItems = 3; 
        const updateLoad = () => {
            itemsLoaded++;
            document.getElementById('p-fill').style.width = (itemsLoaded/totalItems)*100 + '%';
            if(itemsLoaded >= totalItems) {
                setTimeout(() => {
                    document.getElementById('loading-screen').style.display = 'none';
                }, 500);
            }
        };

        // 1. CAR
        loader.load('./car1.glb', (gltf) => { // EXPECTS LOCAL FILE
            carMesh = gltf.scene;
            carMesh.scale.set(1,1,1); // Adjust based on your model
            carMesh.rotation.y = Math.PI;
            scene.add(carMesh);
            applyCarSkin();
            updateLoad();
        }, undefined, () => {
            // Fallback if no file
            console.warn("Car model not found, using box.");
            const geo = new THREE.BoxGeometry(2, 1, 4);
            const mat = new THREE.MeshStandardMaterial({ color: 0x00FFFF, wireframe: true });
            carMesh = new THREE.Mesh(geo, mat);
            scene.add(carMesh);
            updateLoad();
        });

        // 2. CITY / ENV
        // NOTE: Downloading the city to local assets is HIGHLY recommended for performance
        loader.load('https://ashley-developper.github.io/ASLFS/city.glb', (gltf) => {
            cityMesh = gltf.scene;
            cityMesh.scale.set(3,3,3);
            scene.add(cityMesh);
            
            // Generate basic physics from city (Simplified)
            // Ideally, you should load a separate physics mesh or just simple boxes
            updateLoad();
        }, undefined, () => {
            // Fallback environment
            const bGeo = new THREE.BoxGeometry(10, 20, 10);
            const bMat = new THREE.MeshStandardMaterial({color: 0x555555});
            for(let i=0; i<20; i++) {
                const m = new THREE.Mesh(bGeo, bMat);
                m.position.set((Math.random()-0.5)*400, 10, (Math.random()-0.5)*400);
                scene.add(m);
                // Add physics
                const shape = new CANNON.Box(new CANNON.Vec3(5, 10, 5));
                const b = new CANNON.Body({mass:0, position: new CANNON.Vec3(m.position.x, 10, m.position.z)});
                b.addShape(shape);
                world.addBody(b);
            }
            updateLoad();
        });

        // 3. ARROW
        loader.load('./arrow.glb', (gltf) => {
            arrowMesh = gltf.scene;
            arrowMesh.visible = false;
            scene.add(arrowMesh);
            updateLoad();
        }, undefined, () => {
            const geo = new THREE.ConeGeometry(1, 3, 8);
            const mat = new THREE.MeshBasicMaterial({color: 0x00FF00, transparent:true, opacity:0.8});
            arrowMesh = new THREE.Mesh(geo, mat);
            arrowMesh.visible = false;
            arrowMesh.rotation.x = Math.PI; // Point down
            scene.add(arrowMesh);
            updateLoad();
        });
    }

    function applyCarSkin() {
        if(!carMesh) return;
        carMesh.traverse((child) => {
            if(child.isMesh) {
                if(GameState.activeSkin === 'blue') {
                    child.material = new THREE.MeshStandardMaterial({ 
                        color: 0x001133, emissive: 0x0000FF, emissiveIntensity: 0.5, roughness: 0.2
                    });
                }
            }
        });
    }

    // =============================================================================
    // ** DELIVERY & GAMEPLAY LOGIC **
    // =============================================================================
    window.startDeliveryMode = function() {
        if(!isGameRunning) enterGame();
        
        const loc = DELIVERY_LOCS[Math.floor(Math.random() * DELIVERY_LOCS.length)];
        mission = {
            active: true,
            target: new CANNON.Vec3(loc.x, 0, loc.z),
            type: 'pickup',
            timer: 120, // 2 minutes
            name: loc.n
        };
        
        document.getElementById('delivery-hud').style.display = 'block';
        updateMissionUI();
    };

    function updateMissionUI() {
        const title = document.getElementById('mission-status');
        if(mission.type === 'pickup') {
            title.innerText = "GO TO: " + mission.name;
            title.style.color = "#00FFFF";
            if(arrowMesh) arrowMesh.children[0].material.color.setHex(0x00FFFF);
        } else if(mission.type === 'dropoff') {
            title.innerText = "DELIVER TO: " + mission.name;
            title.style.color = "#00FF00";
            if(arrowMesh) arrowMesh.children[0].material.color.setHex(0x00FF00);
        }
    }

    function checkMissionLogic() {
        if(!mission.active) return;

        mission.timer -= 1/60;
        if(mission.timer <= 0) {
            mission.active = false;
            alert("MISSION FAILED: Time Over");
            document.getElementById('delivery-hud').style.display = 'none';
            return;
        }

        // Arrow Logic
        if(arrowMesh) {
            arrowMesh.visible = true;
            arrowMesh.position.copy(chassisBody.position);
            arrowMesh.position.y += 4;
            arrowMesh.lookAt(mission.target.x, arrowMesh.position.y, mission.target.z);
            arrowMesh.rotation.x = Math.PI/2; // Fix rotation depending on your GLB
        }

        const dist = chassisBody.position.distanceTo(mission.target);
        document.getElementById('dist-val').innerText = Math.floor(dist);
        
        // Format Timer
        let m = Math.floor(mission.timer / 60);
        let s = Math.floor(mission.timer % 60);
        document.getElementById('time-val').innerText = `${m}:${s<10?'0'+s:s}`;

        if(dist < 8) {
            if(mission.type === 'pickup') {
                // Switch to Dropoff
                const loc = DELIVERY_LOCS[Math.floor(Math.random() * DELIVERY_LOCS.length)];
                mission.target.set(loc.x, 0, loc.z);
                mission.type = 'dropoff';
                mission.name = loc.n;
                mission.timer += 60; // Bonus time
                updateMissionUI();
                // Visual feedback (Flash HUD)
                document.getElementById('delivery-hud').style.backgroundColor = "#004400";
                setTimeout(()=>document.getElementById('delivery-hud').style.backgroundColor = "rgba(0,20,0,0.8)", 500);

            } else {
                // Complete
                completeMission();
            }
        }
    }

    function completeMission() {
        let reward = 100;
        if(GameState.upgrades.multiplier) reward *= 2; // COIN MULTIPLIER UPGRADE LOGIC
        
        GameState.coins += reward;
        saveGame();
        
        mission.active = false;
        arrowMesh.visible = false;
        document.getElementById('delivery-hud').style.display = 'none';
        
        alert(`MISSION COMPLETE!\nEARNED: ${reward} GOLD`);
    }

    window.enterGame = function() {
        document.getElementById('splash').style.opacity = 0;
        setTimeout(() => document.getElementById('splash').style.display = 'none', 500);
        document.getElementById('hud-layer').style.display = 'flex';
        isGameRunning = true;
        
        // Reset Car
        chassisBody.position.set(0, 2, 0);
        chassisBody.velocity.set(0,0,0);
        chassisBody.quaternion.set(0,0,0,1);
    };

    // =============================================================================
    // ** INPUT & LOOP **
    // =============================================================================
    window.addEventListener('keydown', e => {
        const k = e.key.toLowerCase();
        if(k === 'w') keys.w = true;
        if(k === 'a') keys.a = true;
        if(k === 's') keys.s = true;
        if(k === 'd') keys.d = true;
        if(k === 'shift') keys.shift = true;
        if(k === ' ') keys.space = true;
        if(k === 'v') cameraMode = 1 - cameraMode;
        if(k === 'r') {
            chassisBody.position.y += 2;
            chassisBody.quaternion.set(0,0,0,1);
            chassisBody.velocity.set(0,0,0);
            chassisBody.angularVelocity.set(0,0,0);
        }
    });
    window.addEventListener('keyup', e => {
        const k = e.key.toLowerCase();
        if(k === 'w') keys.w = false;
        if(k === 'a') keys.a = false;
        if(k === 's') keys.s = false;
        if(k === 'd') keys.d = false;
        if(k === 'shift') keys.shift = false;
        if(k === ' ') keys.space = false;
    });

    function animate() {
        requestAnimationFrame(animate);
        
        const dt = 1/60;
        if(isGameRunning) {
            world.step(dt);

            // Car Physics App
            let engine = 0;
            let brake = 0;
            let steer = 0;

            if(keys.w) engine = -maxEngineForce;
            if(keys.s) engine = maxEngineForce / 2;
            if(keys.shift && keys.w) engine *= 1.5; // NITRO LOGIC
            
            if(keys.a) steer = maxSteerVal;
            if(keys.d) steer = -maxSteerVal;
            
            if(keys.space) brake = brakeForce;

            vehicle.applyEngineForce(engine, 2);
            vehicle.applyEngineForce(engine, 3);
            vehicle.setSteeringValue(steer, 0);
            vehicle.setSteeringValue(steer, 1);
            vehicle.setBrake(brake, 0);
            vehicle.setBrake(brake, 1);
            vehicle.setBrake(brake, 2);
            vehicle.setBrake(brake, 3);

            // HUD
            document.getElementById('hud-spd').innerText = Math.floor(chassisBody.velocity.length() * 3.6);
            document.getElementById('hud-rpm').innerText = Math.floor(Math.abs(engine) / 10);
            
            checkMissionLogic();
        }

        // Sync Meshes
        for(let i=0; i<vehicle.wheelInfos.length; i++) {
            vehicle.updateWheelTransform(i);
            const t = vehicle.wheelInfos[i].worldTransform;
            vehicle.wheelInfos[i].mesh.position.copy(t.position);
            vehicle.wheelInfos[i].mesh.quaternion.copy(t.quaternion);
        }

        if(carMesh) {
            carMesh.position.copy(chassisBody.position);
            carMesh.quaternion.copy(chassisBody.quaternion);
            carMesh.position.y -= 0.5; // Offset
        }

        // Camera Follow
        if(carMesh) {
            if(cameraMode === 0) { // Chase
                const offset = new THREE.Vector3(0, 3, 6);
                offset.applyQuaternion(chassisBody.quaternion);
                offset.add(chassisBody.position);
                camera.position.lerp(offset, 0.1);
                camera.lookAt(chassisBody.position.x, chassisBody.position.y + 1, chassisBody.position.z);
            } else { // Cockpit
                const offset = new THREE.Vector3(0, 1.2, 0.5);
                offset.applyQuaternion(chassisBody.quaternion);
                offset.add(chassisBody.position);
                camera.position.copy(offset);
                camera.rotation.copy(carMesh.rotation);
                camera.rotation.y += Math.PI;
            }
        }

        renderer.render(scene, camera);
    }

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    window.onload = init;

    </script>
</body>
</html>
